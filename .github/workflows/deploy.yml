deploy:
  needs: test
  if: github.ref == 'refs/heads/main'
  runs-on: ubuntu-latest

  steps:
    - uses: actions/checkout@v4

    - name: Verify server connectivity
      run: |
        echo "Pinging ${{ env.SERVER_IP }}..."
        ping -c 3 ${{ env.SERVER_IP }} || echo "Ping test failed"

        echo "Testing SSH port 22..."
        nc -zv -w 5 ${{ env.SERVER_IP }} 22 || echo "Port test failed"

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: Validate SSH connection
      run: |
        ssh -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=10 \
            ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} \
            "echo 'âœ… SSH connection successful'"

    - name: Sync .env before deploy
      run: |
        echo "Transferring .env to server..."
        scp -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            .env ${{ env.SERVER_USER }}@${{ env.SERVER_IP }}:${{ env.APP_DIR }}/.env.tmp

        echo "Setting permissions..."
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} "
          mv ${{ env.APP_DIR }}/.env.tmp ${{ env.APP_DIR }}/.env
          chmod 600 ${{ env.APP_DIR }}/.env
        "

    - name: Deploy application with logs
      run: |
        ssh -T ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} << 'EOF'
        set -xe

        echo "ðŸ“ Changing to app directory..."
        cd "${APP_DIR}"

        echo "ðŸ“¦ Fetching latest code..."
        git fetch --all
        git reset --hard origin/main

        echo "ðŸ“¦ Installing prod dependencies..."
        npm ci --omit=dev

        echo "ðŸš€ Restarting app with PM2..."
        if pm2 list | grep -q "${PM2_APP_NAME}"; then
          pm2 restart "${PM2_APP_NAME}"
        else
          pm2 start npm --name "${PM2_APP_NAME}" -- start
          pm2 save
        fi
        EOF

    - name: Verify deployment
      run: |
        ssh -T ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} << 'EOF'
        echo -e '\nâœ… === PM2 STATUS ==='
        pm2 list

        echo -e '\nâœ… === LATEST COMMIT ==='
        cd "${APP_DIR}"
        git log -1 --oneline
        EOF
